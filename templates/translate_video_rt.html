<script>
const $ = s => document.querySelector(s);
const log = m => $('#log').textContent = m || '';

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function start(e){
  e.preventDefault();
  const videoUrl = $('#url').value.trim();
  if(!videoUrl){ return; }
  log('جارٍ بدء الجلسة…');

  // ابدأ جلسة الترجمة (كما كانت)
  let sid = null;
  try{
    const fd = new FormData(); fd.append('video_url', videoUrl);
    const sres = await fetch('/rt/start', { method:'POST', body: fd });
    const sj = await sres.json();
    if(sj && sj.ok && sj.sid){
      sid = sj.sid;
      log('متصل… يتم الاستماع للصوت وترجمته');
    }else{
      log('تعذر بدء جلسة الترجمة: ' + (sj && sj.error ? sj.error : ''));
    }
  }catch(err){
    log('تعذر بدء جلسة الترجمة: ' + (err && err.message ? err.message : err));
  }

  // دائماً وفر زر فتح خارجي + صندوق الترجمة
  $('#player').innerHTML =
    '<div style="padding:12px;background:#0f1220;border:1px solid #2a2f45;border-radius:10px;margin-bottom:10px">' +
    'رابط الفيديو: <a target="_blank" href="'+videoUrl+'">فتح في تبويب جديد</a>' +
    '</div>' +
    '<div id="innerPlayer"></div>' +
    '<div class="subs" id="subs"></div>';

  // حاول استخراج رابط مباشر
  let playable = null, resolveErr = null;
  try{
    const r = await fetch('/resolve?video_url=' + encodeURIComponent(videoUrl));
    const j = await r.json();
    if(j.ok && j.url){ playable = j.url; }
    else resolveErr = j.error || 'لم يتم العثور على رابط تشغيل مباشر';
  }catch(err){ resolveErr = err && err.message ? err.message : String(err); }

  if(playable){
    $('#innerPlayer').innerHTML =
      '<video id="vid" src="'+playable+'" controls autoplay playsinline></video>';
  }else{
    $('#innerPlayer').innerHTML =
      '<div style="padding:10px;border-radius:10px;border:1px dashed #475569;color:#98a2b3">' +
      'تعذّر تشغيل الفيديو داخل الصفحة. السبب: ' + escapeHtml(resolveErr || 'غير معروف') +
      '<br/>يمكنك المشاهدة في التبويب الخارجي، وستبقى الترجمة الحية هنا.' +
      '</div>';
  }

  // افتح WebSocket للترجمة
  if(sid){
    const wsProto = (location.protocol === 'https:') ? 'wss' : 'ws';
    const ws = new WebSocket(wsProto + '://' + location.host + '/ws/' + sid);
    ws.onmessage = ev => {
      try{
        const d = JSON.parse(ev.data);
        if(d.type === 'line'){
          $('#subs').innerHTML = '<span class="line">' + escapeHtml(d.ar || d.src || '') + '</span>';
        }else if(d.type === 'error'){
          log('خطأ: ' + d.error);
        }else if(d.type === 'done'){
          log('انتهى البث.');
        }
      }catch(e){}
    };
    ws.onclose = ()=> log('انتهى الاتصال');
  }
}

document.getElementById('f').addEventListener('submit', start);
</script>

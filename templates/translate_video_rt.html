<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø­ÙŠÙ‘Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <style>
    body{background:#0b0f19;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic UI","Noto Kufi Arabic",Tahoma,Arial,sans-serif;margin:0}
    .wrap{max-width:960px;margin:24px auto;padding:0 14px}
    .card{background:#121826;border-radius:18px;padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:6px 0 14px;font-size:28px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="url"]{flex:1;min-width:260px;padding:12px 14px;border-radius:12px;border:none;background:#0f1421;color:#fff}
    button{padding:12px 16px;border-radius:12px;border:none;background:#7c3aed;color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:#6d28d9}
    .muted{color:#98a2b3}
    #log{margin-top:14px}
    #player{margin-top:16px}
    video{width:100%;max-height:60vh;border-radius:12px;background:#000}
    .subs{margin-top:10px;min-height:40px;background:#0f1220;border:1px solid #2a2f45;border-radius:10px;padding:10px 12px;line-height:1.8}
    .line{background:#1f2937;border-radius:8px;padding:6px 10px;display:inline-block}
    a{color:#c4b5fd;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ§ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø­ÙŠÙ‘Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ</h1>
      <p class="muted">Ø£Ù„ØµÙÙ‚ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ (YouTube/Twitch/MP4/M3U8â€¦) Ø«Ù… Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£".</p>

      <form id="f" class="row">
        <button type="submit">Ø§Ø¨Ø¯Ø£</button>
        <input id="url" type="url" placeholder="https://..." required/>
      </form>

      <div id="log" class="muted"></div>
      <div id="player"></div>
    </div>
  </div>

  <script>
  const $ = s => document.querySelector(s);
  const log = m => $('#log').textContent = m || '';

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function start(e){
    e.preventDefault();
    const videoUrl = $('#url').value.trim();
    if(!videoUrl){ return; }
    log('Ø¬Ø§Ø±Ù Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©â€¦');

    // 1) Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø­ÙŠÙ‘Ø© (Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¯ÙŠÙƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§)
    const fd = new FormData(); fd.append('video_url', videoUrl);
    const sres = await fetch('/rt/start', { method:'POST', body: fd });
    const sj = await sres.json().catch(()=>({ok:false,error:'bad json'}));
    if(!sj || !sj.ok || !sj.sid){
      log('ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø©: ' + (sj && sj.error ? sj.error : ''));
      // Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ØªØŒ Ø³Ù†Ø­Ø§ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ â€” Ù„ÙƒÙ† Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù„Ù† ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø³Ø©
    } else {
      log('Ù…ØªØµÙ„â€¦ ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØµÙˆØª ÙˆØªØ±Ø¬Ù…ØªÙ‡');
    }

    // 2) Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± /resolve
    let playable = null;
    try{
      const r = await fetch('/resolve?video_url=' + encodeURIComponent(videoUrl));
      const j = await r.json();
      if(j.ok && j.url){ playable = j.url; }
    }catch(_){}

    if(playable){
      $('#player').innerHTML =
        '<video id="vid" src="'+playable+'" controls autoplay playsinline></video>' +
        '<div class="subs" id="subs"></div>';
    }else{
      // Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬/Ø§Ù„ØªØ¶Ù…ÙŠÙ†: Ù†Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· ÙØªØ­ Ø®Ø§Ø±Ø¬ÙŠ ÙˆÙ†Ø¨Ù‚ÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø©
      $('#player').innerHTML =
        '<div style="padding:12px;background:#0f1220;border:1px solid #2a2f45;border-radius:10px">' +
        'ØªØ¹Ø°Ù‘Ø± ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© (ØºØ§Ù„Ø¨Ù‹Ø§ Ù‚ÙŠÙˆØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±). ' +
        '<a target="_blank" href="'+videoUrl+'">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</a>' +
        '</div>' +
        '<div class="subs" id="subs"></div>';
    }

    // 3) Ø§ÙØªØ­ WebSocket Ù„ØªÙ„Ù‚Ù‘ÙŠ Ø§Ù„Ø³Ø·ÙˆØ± Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø© Ø­ÙŠÙ‹Ø§ (Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¯ÙŠÙƒ)
    if(sj && sj.sid){
      const wsProto = (location.protocol === 'https:') ? 'wss' : 'ws';
      const ws = new WebSocket(wsProto + '://' + location.host + '/ws/' + sj.sid);

      ws.onmessage = ev => {
        try{
          const d = JSON.parse(ev.data);
          if(d.type === 'line'){
            // d.ar Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ¯Ø±
            $('#subs').innerHTML = '<span class="line">' + escapeHtml(d.ar || d.src || '') + '</span>';
          }else if(d.type === 'error'){
            log('Ø®Ø·Ø£: ' + d.error);
          }else if(d.type === 'done'){
            log('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø«.');
          }
        }catch(e){}
      };
      ws.onclose = ()=> log('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
  }

  document.getElementById('f').addEventListener('submit', start);
  </script>
</body>
</html>

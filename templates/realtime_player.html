<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>الترجمة الحيّة للفيديو</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <style>
    body{background:#0b0f19;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic UI","Noto Kufi Arabic","Tahoma",sans-serif}
    .wrap{max-width:960px;margin:24px auto;padding:16px;background:#121826;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="url"]{flex:1;min-width:260px;padding:12px 14px;border:none;border-radius:12px;background:#0f1421;color:#fff}
    button{padding:12px 16px;border:none;border-radius:12px;background:#7c3aed;color:#fff;font-weight:700;cursor:pointer}
    .player{position:relative;margin-top:16px;background:#000;border-radius:12px;overflow:hidden}
    .player iframe, .player video{width:100%;height:56.25vw;max-height:60vh;display:block}
    .subs{position:absolute;left:0;right:0;bottom:8px;text-align:center;padding:0 16px}
    .line{display:inline-block;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font-size:18px}
    .status{margin-top:10px;color:#98a2b3}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>الترجمة الحيّة للفيديو 🎧</h1>
    <p class="status">ألصق رابط فيديو (YouTube/Twitch/MP4/M3U8…) ثم اضغط "ابدأ".</p>
    <form id="f" class="row">
      <button type="submit">ابدأ</button>
      <input id="url" type="url" placeholder="https://..." required value="{{ video_url }}"/>
    </form>

    <div class="player" id="player">
      <!-- سيظهر الفيديو هنا -->
      <div class="subs" id="subs"></div>
    </div>
    <div class="status" id="log"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const log = (msg) => { $('#log').textContent = msg; };

async function start(e){
  e.preventDefault();
  const videoUrl = $('#url').value.trim();
  if(!videoUrl) return;

  log('جارٍ بدء الجلسة…');
  const fd = new FormData();
  fd.append('video_url', videoUrl);
  const res = await fetch('/rt/start', {method:'POST', body:fd});
  const j = await res.json();
  if(!j.ok){ log('تعذّر البدء: ' + (j.error||'')); return; }

  const sid = j.sid;
  const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws/'+sid);
  ws.onopen = () => { log('متصل… يتم الاستماع للصوت وترجمته'); };

  ws.onmessage = (ev)=>{
    try{
      const data = JSON.parse(ev.data);
      if(data.type==='meta'){
        if(data.embed){
          $('#player').innerHTML = '<iframe src="'+data.embed+'" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe><div class="subs" id="subs"></div>';
        }else{
          // فيديو HTML5 مباشر
          $('#player').innerHTML = '<video id="vid" src="'+videoUrl+'" controls autoplay></video><div class="subs" id="subs"></div>';
        }
      }else if(data.type==='line'){
        $('#subs').innerHTML = '<span class="line">'+escapeHtml(data.ar || data.src)+'</span>';
      }else if(data.type==='error'){
        log('خطأ: '+data.error);
      }else if(data.type==='done'){
        log('انتهى البث.');
      }
    }catch(e){ console.warn(e); }
  };
  ws.onclose = ()=> log('انتهى الاتصال');
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

$('#f').addEventListener('submit', start);
</script>
</body>
</html>

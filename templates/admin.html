<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>لوحة بسام الذكي</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--line:#1f2937;--txt:#e5e7eb;--muted:#9ca3af;--brand:#7c3aed}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1220,#05070c);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Tahoma}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px;margin:16px 0}
    h1,h2{margin:8px 0 12px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    input,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0d1324;color:var(--txt)}
    button{cursor:pointer;background:linear-gradient(90deg,var(--brand),#9b59ff);border:none;font-weight:800}
    button:hover{filter:brightness(1.08);transform:translateY(-1px);transition:.18s}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:#22c55e}.err{color:#ef4444}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    a{color:#7dd3fc;text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">

  {% if login %}
    <div class="card">
      <h1>تسجيل الدخول للوحة الإدارة</h1>
      {% if error %}<p class="err">{{ error }}</p>{% endif %}
      <form action="/admin/login" method="post" style="max-width:420px">
        <label>كلمة المرور</label>
        <input type="password" name="password" required placeholder="••••••"/>
        <div class="actions">
          <button type="submit">دخول</button>
        </div>
      </form>
    </div>
  {% else %}
    <div class="topbar">
      <h1>لوحة بسام الذكي</h1>
      <div class="actions">
        <a href="/admin/export.csv">تصدير CSV</a>
        <a href="/admin/logout">تسجيل خروج</a>
      </div>
    </div>

    <div class="card">
      <h2>اختبار الإشعارات السريعة</h2>
      <div class="row">
        <div>
          <h3>إشعار تجريبي</h3>
          <label>العنوان</label>
          <input id="t_title" value="📣 إشعار تجريبي"/>
          <label>النص</label>
          <input id="t_body" value="مرحبًا! هذا إشعار من بسام الذكي"/>
          <div class="actions">
            <button id="btnTest">إرسال الإشعار التجريبي</button>
            <span id="t_res" class="muted"></span>
          </div>
        </div>

        <div>
          <h3>إشعار مباراة</h3>
          <label>الفريق المستضيف (Home)</label>
          <input id="m_home" value="Al Hilal"/>
          <label>الفريق الضيف (Away)</label>
          <input id="m_away" value="Al Nassr"/>
          <label>قبل 30 دقيقة؟</label>
          <select id="m_before">
            <option value="1">نعم (⏰ قبل 30 دقيقة)</option>
            <option value="0" selected>لا (🎬 بداية المباراة)</option>
          </select>
          <div class="actions">
            <button id="btnMatch">إرسال إشعار المباراة</button>
            <span id="m_res" class="muted"></span>
          </div>
          <p class="muted">سيحوي الإشعار رابطًا يفتح صفحة <code>/deeplink</code>، والتي تحاول فتح Yacine تلقائيًا.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>آخر السجلات</h2>
      <table>
        <thead><tr><th>ID</th><th>الوقت (UTC)</th><th>النوع</th><th>الاستعلام/الملف</th><th>المحرّك/الوصف</th><th>IP</th></tr></thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.ts }}</td>
            <td>{{ r.type }}</td>
            <td>{{ r.query or r.file_name }}</td>
            <td>{{ r.engine_used }}</td>
            <td>{{ r.ip }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <p class="muted">ملاحظة: الجدولة التلقائية تعمل على توقيت مكة ({{ TIMEZONE or 'Asia/Riyadh' }}).</p>
    </div>
  {% endif %}

</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const btnTest = $('btnTest');
  if (btnTest) {
    btnTest.onclick = async () => {
      const title = encodeURIComponent($('t_title').value || '');
      const body  = encodeURIComponent($('t_body').value  || '');
      $('t_res').textContent = '... جاري الإرسال';
      try {
        const r = await fetch(`/admin/push-test?title=${title}&body=${body}`);
        const j = await r.json();
        $('t_res').textContent = j.ok ? '✅ تم الإرسال' : '❌ فشل الإرسال';
        $('t_res').className = j.ok ? 'ok' : 'err';
      } catch(e){ $('t_res').textContent = '❌ خطأ في الاتصال'; $('t_res').className='err'; }
    };
  }

  const btnMatch = $('btnMatch');
  if (btnMatch) {
    btnMatch.onclick = async () => {
      const home = encodeURIComponent($('m_home').value || '');
      const away = encodeURIComponent($('m_away').value || '');
      const before = $('m_before').value === '1' ? 'true' : 'false';
      $('m_res').textContent = '... جاري الإرسال';
      try {
        const r = await fetch(`/admin/push-match?home=${home}&away=${away}&before=${before}`);
        const j = await r.json();
        $('m_res').textContent = j.ok ? '✅ تم الإرسال' : '❌ فشل الإرسال';
        $('m_res').className = j.ok ? 'ok' : 'err';
      } catch(e){ $('m_res').textContent = '❌ خطأ في الاتصال'; $('m_res').className='err'; }
    };
  }
</script>
</body>
</html>

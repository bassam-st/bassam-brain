<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🎧 ترجمة حيّة — بسام براين</title>
  <style>
    body{background:#0b0f19;color:#e5e7eb;font-family:system-ui,Arial;padding:18px;text-align:center}
    h2{color:#c4b5fd;margin:10px 0 18px}
    form{margin-bottom:16px}
    input{padding:10px;border-radius:10px;border:none;width:70%;max-width:560px;background:#0f1421;color:#fff}
    button{padding:10px 16px;border:none;border-radius:10px;background:#7c3aed;color:#fff;cursor:pointer;margin-top:10px}
    video{width:100%;max-width:960px;margin:16px auto;border-radius:14px;display:block;background:#000}
    .subs{max-width:960px;margin:10px auto;text-align:right;background:#111827;border:1px solid #2a2f45;border-radius:14px;padding:12px}
    .line{padding:6px 8px;border-bottom:1px dashed #2a2f45}
    .muted{color:#9ca3af}
    .error{color:#ef4444}
  </style>
</head>
<body>
  <h2>🎬 بسام — ترجمة الفيديو الحيّة إلى العربية</h2>
  <form method="post" action="/translate_video_rt">
    <input type="text" name="video_url" placeholder="ألصق رابط الفيديو هنا..." required/>
    <div><button type="submit">ابدأ الترجمة الآن 🎧</button></div>
  </form>

  {% if video_url %}
    <video controls autoplay src="{{ video_url }}"></video>

    <div id="subs" class="subs">
      <div class="line muted">جاري بدء الترجمة الحية... هذا عرض تجريبي.</div>
    </div>

    <script>
      (function () {
        const url = "{{ video_url }}";
        const subs = document.getElementById('subs');
        const ev = new EventSource('/sse_subs?url=' + encodeURIComponent(url));

        function addLine(html, cls="") {
          const div = document.createElement('div');
          div.className = 'line ' + cls;
          div.innerHTML = html;
          subs.appendChild(div);
          subs.scrollTop = subs.scrollHeight;
        }

        ev.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.type === 'final') {
              addLine(`<b>الترجمة:</b> ${data.ar}<br><span class="muted">(${data.src})</span>`);
            } else if (data.type === 'fallback') {
              addLine('⚠️ ' + data.msg, 'muted');
            } else if (data.type === 'info') {
              addLine('ℹ️ ' + data.msg, 'muted');
            } else if (data.type === 'error') {
              addLine('❌ ' + data.msg, 'error');
            } else if (data.type === 'done') {
              addLine('✅ اكتملت الترجمة.');
              ev.close();
            }
          } catch (err) {
            addLine('❌ خطأ في قراءة البث.', 'error');
          }
        };

        ev.onerror = () => {
          addLine('❌ انقطع بث الترجمة.', 'error');
          ev.close();
        };
      })();
    </script>
  {% endif %}
</body>
</html>

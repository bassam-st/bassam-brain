<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¨Ø³Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ â€” Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ‚ ÙˆØªÙ„Ø®ÙŠØµ ØªÙ„Ù‚Ø§Ø¦ÙŠ</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/pwa/manifest.json">
  <meta name="theme-color" content="#0b0f19"/>

  <!-- CSS -->
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
<header class="top">
  <h1>Ø¨Ø³Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ ğŸ” â€” Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ‚ ÙˆØªÙ„Ø®ÙŠØµ ØªÙ„Ù‚Ø§Ø¦ÙŠ</h1>
  <div class="actions">
    <button id="installBtn" hidden>ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    <button id="themeBtn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ">â˜€ï¸/ğŸŒ™</button>
  </div>
</header>

<section class="card">
  <form id="searchForm" class="row">
    <label class="chk"><input type="checkbox" id="price_links" name="price_links"/> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</label>
    <input id="q" name="q" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." required/>
    <button id="goBtn" type="submit">Ø¨Ø­Ø«</button>
  </form>
</section>

<main id="answer" class="card answer"></main>

<footer class="foot">Â© Bassam AI â€” 2025</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Theme toggle
  const themeBtn = document.getElementById("themeBtn");
  themeBtn.addEventListener("click", () => {
    const dark = document.body.classList.toggle("dark");
    localStorage.setItem("theme", dark ? "dark" : "light");
  });
  if(localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

  // PWA install prompt
  const installBtn = document.getElementById("installBtn");
  let deferredPrompt;
  window.addEventListener("beforeinstallprompt", e => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.hidden = false;
  });
  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.hidden = true;
  });

  // Ø§Ù„Ø¨Ø­Ø«
  const form   = document.getElementById("searchForm");
  const input  = document.getElementById("q");
  const price  = document.getElementById("price_links");
  const btn    = document.getElementById("goBtn");
  const answer = document.getElementById("answer");

  async function doSearch(e){
    e.preventDefault();
    const q = (input.value || "").trim();
    if (!q){ input.focus(); return; }

    btn.disabled = true;
    const old = btn.innerText;
    btn.innerText = "ÙŠØ¨Ø­Ø«â€¦";
    answer.innerHTML = `<div class="loading">ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„...</div>`;

    try {
      const fd = new FormData();
      fd.append("q", q);
      if (price && price.checked) fd.append("price_links", "on");

      const res = await fetch("/search", { method: "POST", body: fd });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("HTTP " + res.status + ": " + txt);
      }
      const html = await res.text();
      answer.innerHTML = html;
    } catch (err) {
      console.error(err);
      answer.innerHTML = `<div class="error">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.<br><pre>${String(err)}</pre></div>`;
    } finally {
      btn.disabled = false;
      btn.innerText = old;
    }
  }

  form.addEventListener("submit", doSearch);
});
</script>

</body>
</html>

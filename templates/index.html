<script>
document.addEventListener("DOMContentLoaded", () => {
  const form   = document.getElementById("searchForm");
  const input  = document.getElementById("q");
  const price  = document.getElementById("price_links"); // صندوق "روابط الأسعار" إن وجد
  const btn    = document.getElementById("goBtn");       // زر "بحث"
  const answer = document.getElementById("answer");      // مكان عرض النتيجة

  async function doSearch(e){
    e.preventDefault();               // منع إعادة تحميل الصفحة
    const q = (input.value || "").trim();
    if (!q){ input.focus(); return; }

    // حالة تحميل بسيطة
    btn.disabled = true;
    const old = btn.innerText;
    btn.innerText = "يبحث…";
    answer.innerHTML = `<div class="loading">🔎 جاري البحث والتحليل…</div>`;

    try{
      const fd = new FormData();
      fd.append("q", q);
      if (price && price.checked) fd.append("price_links", "on");

      const res = await fetch("/search", { method: "POST", body: fd });
      if (!res.ok){
        const txt = await res.text();
        throw new Error("HTTP " + res.status + ": " + txt);
      }
      const html = await res.text();     // الـ backend يُرجع HTML جاهز
      answer.innerHTML = html;
    }catch(err){
      console.error(err);
      answer.innerHTML = `
        <div class="error">
          حدث خطأ أثناء البحث. جرّب مرة أخرى.
          <pre style="white-space:pre-wrap">${String(err)}</pre>
        </div>`;
    }finally{
      btn.disabled = false;
      btn.innerText = old;
    }
  }

  form.addEventListener("submit", doSearch);
});
</script>
